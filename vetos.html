<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Vetos de Mapas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  margin:0;
  font-family:Arial,sans-serif;
  color:#fff;
}

/* Fundo com v√≠deo do YouTube */
#yt-bg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  overflow: hidden;
}
#yt-bg iframe {
  width: 177.77vh;
  height: 100vh;
  min-width: 100vw;
  min-height: 56.25vw;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
}

.tela{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.box{
  background:#111;
  padding:25px;
  border-radius:15px;
  width:100%;
  max-width:500px;
  text-align:center;
}
button{
  padding:10px 20px; margin:5px; border:none; border-radius:8px; cursor:pointer;
}
button:disabled{ opacity:0.5; cursor:not-allowed; }
.map-grid{ display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin-top:15px; }
.map-item{ width:140px; text-align:center; cursor:pointer; }
.map-item img{ width:100%; border-radius:8px; transition:0.3s; }
.map-item img:hover{ transform: scale(1.05); }
#infoTurno{
  margin-top:10px;
  font-size:14px;
  color:#ccc;
}
</style>
</head>
<body>

<!-- Fundo com v√≠deo do YouTube -->
<div id="yt-bg">
  <iframe 
    src="https://www.youtube.com/embed/bSapqDCxlgw?autoplay=1&mute=1&controls=0&loop=1&playlist=bSapqDCxlgw" 
    frameborder="0"
    allow="autoplay; fullscreen" 
    allowfullscreen>
  </iframe>
</div>

<!-- Tela inicial -->
<div id="telaInicial" class="tela" style="display:flex;">
  <div class="box">
    <h1>Vetos de Mapas</h1>
    <button onclick="abrirModo()">Iniciar Vetos</button>
  </div>
</div>

<!-- Escolha do modo -->
<div id="telaModo" class="tela">
  <div class="box">
    <h1>Escolha o modo</h1>
    <button onclick="gerarSala(1)">MD1</button>
    <button onclick="gerarSala(3)">MD3</button>
    <button onclick="gerarSala(5)">MD5</button>
    <button onclick="voltarTelaInicial()">Voltar</button>
  </div>
</div>

<!-- Sala e link -->
<div id="telaSala" class="tela">
  <div class="box">
    <h2>Link da sala</h2>
    <p id="linkSala"></p>
    <button onclick="copiarLink()">üìã Copiar Link</button>
    <button onclick="iniciarVeto()">Entrar na Sala</button>
  </div>
</div>

<!-- Tela de veto -->
<div id="telaVeto" class="tela">
  <div class="box">
    <h1>Vetos de Mapas</h1>
    <p style="font-size:12px;color:#aaa;">O jogador que escolher primeiro escolhe o lado</p>
    <p id="infoTurno">Aguardando vez...</p>
    <div class="map-grid" id="mapasContainer"></div>
    <button id="btnEncerrar" style="display:none;" onclick="window.location.reload()">Encerrar Sess√£o</button>
  </div>
</div>

<!-- Tela resultado -->
<div id="telaResultado" class="tela">
  <div class="box">
    <h1>Mapas Escolhidos</h1>
    <div class="map-grid" id="mapasFinais"></div>
    <button onclick="window.location.reload()">Voltar ao In√≠cio</button>
  </div>
</div>

<script>
// LISTA DE MAPAS
const mapas = [
  {nome:'5TH DEPOT', img:'dp5.mapa.png'},
  {nome:'CROSSPORT', img:'crossport.png'},
  {nome:'DESERT2', img:'desert2.png'},
  {nome:'PROVENCE', img:'provence.png'},
  {nome:'CITY CAT', img:'citycat.png'},
  {nome:'WHITE SQUALL', img:'wihtiSqual.png'},
  {nome:'OLD TOWM', img:'oldTowm.png'},
  {nome:'DRAGONROAD', img:'dragonround.png'},
  {nome:'TWOFACE', img:'TOWFACE.jpg'},
  {nome:'DEPOT', img:'DEPOT.png'}
];

// FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyCk5TKmEJbeoyO4GunMmsAzHQksaY7FeNU",
  authDomain: "vetos-de-mapas.firebaseapp.com",
  databaseURL: "https://vetos-de-mapas-default-rtdb.firebaseio.com",
  projectId: "vetos-de-mapas",
  storageBucket: "vetos-de-mapas.appspot.com",
  messagingSenderId: "965916020174",
  appId: "1:965916020174:web:676ae987f76b10631e6f9f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// VARI√ÅVEIS
let modo = 1;
let salaID = "";
let jogadorID = Math.random().toString(36).substring(2,8);
let mapasVetados = [];
let mapasEscolhidos = [];
let jogador1 = "";
let jogador2 = "";
let turnoIndex = 0;
let turnos = [];

// Detecta se entrou por link
const params = new URLSearchParams(window.location.search);
const salaParam = params.get("sala");
const jogadorParam = params.get("jogador");

if(salaParam && jogadorParam){
    salaID = salaParam;
    jogadorID = jogadorParam;

    document.getElementById("telaInicial").style.display = "none";
    document.getElementById("telaModo").style.display = "none";
    document.getElementById("telaSala").style.display = "none";
    document.getElementById("telaVeto").style.display = "flex";

    inicializarFirebase();
    renderizarMapas();
}

function abrirModo(){
  document.getElementById("telaInicial").style.display="none";
  document.getElementById("telaModo").style.display="flex";
}

function voltarTelaInicial(){
  document.getElementById("telaModo").style.display="none";
  document.getElementById("telaInicial").style.display="flex";
}

function gerarSala(sel){
  modo = sel;
  salaID = Math.random().toString(36).substring(2,8);

  db.ref("salas/" + salaID).set({
    modo: modo,
    jogador1: jogadorID,
    jogador2: "",
    vetos: [],
    escolhidos: [],
    turnoIndex: 0
  });

  const link = `${location.origin}${location.pathname}?sala=${salaID}&jogador=${Math.random().toString(36).substring(2,8)}`;
  document.getElementById("linkSala").innerHTML = `<a href="${link}" target="_blank">${link}</a>`;

  document.getElementById("telaModo").style.display="none";
  document.getElementById("telaSala").style.display="flex";
}

function copiarLink(){
  navigator.clipboard.writeText(document.getElementById("linkSala").innerText);
  alert("Link copiado!");
}

function iniciarVeto(){
  document.getElementById("telaSala").style.display="none";
  document.getElementById("telaVeto").style.display="flex";

  inicializarFirebase();
  renderizarMapas();
}

// SEQU√äNCIA JUSTA DE TURNOS PARA CADA MODO
function gerarTurnos(modo){
  const arr = [];
  if(modo === 1){
    // MD1: vetar at√© sobrar 1 mapa
    const vetos = mapas.length - 1;
    for(let i=0;i<vetos;i++){
      arr.push({acao:'vetar', jogador:(i%2===0?'j1':'j2')});
    }
  } else if(modo === 3){
    // MD3
    arr.push({acao:'escolher', jogador:'j1'});
    arr.push({acao:'vetar', jogador:'j2'});
    arr.push({acao:'vetar', jogador:'j1'});
    arr.push({acao:'escolher', jogador:'j2'});
    arr.push({acao:'escolher', jogador:'j1'});
  } else if(modo === 5){
    // MD5: 5 mapas finais, exemplo 9 turnos alternando
    arr.push({acao:'escolher', jogador:'j1'});
    arr.push({acao:'vetar', jogador:'j2'});
    arr.push({acao:'vetar', jogador:'j1'});
    arr.push({acao:'escolher', jogador:'j2'});
    arr.push({acao:'escolher', jogador:'j1'});
    arr.push({acao:'vetar', jogador:'j2'});
    arr.push({acao:'escolher', jogador:'j2'});
    arr.push({acao:'vetar', jogador:'j1'});
    arr.push({acao:'escolher', jogador:'j1'});
  }
  return arr;
}

// RENDERIZA MAPAS
function renderizarMapas(){
  const c = document.getElementById("mapasContainer");
  c.innerHTML = "";
  const turnoAtual = turnos[turnoIndex];
  const acao = turnoAtual ? turnoAtual.acao : null;
  const jogadorTurno = turnoAtual ? turnoAtual.jogador : null;
  const isMinhaVez = ( (jogadorID === jogador1 && jogadorTurno==='j1') || (jogadorID===jogador2 && jogadorTurno==='j2') );

  mapas.forEach(m => {
    const div = document.createElement("div");
    div.className = "map-item";
    div.innerHTML = `<img src="${m.img}"><p>${m.nome}</p>`;

    const escolhido = mapasEscolhidos.includes(m.nome);
    const vetado = mapasVetados.includes(m.nome);
    if(vetado || (acao==='escolher' && !isMinhaVez) || (acao==='vetar' && !isMinhaVez) || escolhido){
      div.querySelector("img").style.opacity = "0.4";
      div.style.pointerEvents = "none";
    }

    div.onclick = () => { selecionarMapa(m.nome); };
    c.appendChild(div);
  });

  const info = document.getElementById("infoTurno");
  if(!turnoAtual){
    info.innerText = "Aguardando advers√°rio...";
  } else {
    if(acao==='escolher' && isMinhaVez) info.innerText="Sua vez de escolher";
    else if(acao==='vetar' && isMinhaVez) info.innerText="Sua vez de vetar";
    else info.innerText="Aguardando advers√°rio...";
  }
}

// SELECIONA OU VETA MAPA
function selecionarMapa(nome){
  const turnoAtual = turnos[turnoIndex];
  if(!turnoAtual) return;

  if(turnoAtual.acao==='escolher') mapasEscolhidos.push(nome);
  if(turnoAtual.acao==='vetar') mapasVetados.push(nome);

  turnoIndex++;

  db.ref("salas/" + salaID).update({
    vetos: mapasVetados,
    escolhidos: mapasEscolhidos,
    turnoIndex: turnoIndex
  });

  verificarFinal();
}

// INICIALIZA FIREBASE
function inicializarFirebase(){
  db.ref("salas/" + salaID).on("value", snap => {
    const sala = snap.val();
    if(!sala) return;

    jogador1 = sala.jogador1;
    jogador2 = sala.jogador2 || "";
    if(!jogador2 && jogadorID!==jogador1){
      db.ref("salas/" + salaID).update({jogador2:jogadorID});
      jogador2 = jogadorID;
    }

    mapasVetados = sala.vetos || [];
    mapasEscolhidos = sala.escolhidos || [];
    turnoIndex = sala.turnoIndex || 0;

    if(!turnos.length) turnos = gerarTurnos(sala.modo);

    renderizarMapas();
    verificarFinal();
  });
}

// VERIFICA FINAL DE MODOS
function verificarFinal(){
  const finais = mapasEscolhidos.slice();
  let maxMapas = modo; // MD1, MD3, MD5
  if(modo === 1) maxMapas = 1; // MD1, apenas 1 mapa final
  if(modo === 3) maxMapas = 3;
  if(modo === 5) maxMapas = 5;

  if(finais.length >= maxMapas){
    document.getElementById("mapasContainer").style.pointerEvents="none";
    document.getElementById("btnEncerrar").style.display="inline-block";
    mostrarTelaResultado();
  }
}

// MOSTRA RESULTADO FINAL
function mostrarTelaResultado(){
  document.getElementById("telaVeto").style.display="none";

  const finais = mapasEscolhidos.slice();
  const c = document.getElementById("mapasFinais");
  c.innerHTML = "";

  finais.forEach(mNome => {
    const m = mapas.find(mm => mm.nome===mNome);
    const div = document.createElement("div");
    div.className="map-item";
    div.innerHTML=`<img src="${m.img}"><p>${m.nome}</p>`;
    c.appendChild(div);
  });

  document.getElementById("telaResultado").style.display="flex";
}
</script>

</body>
</html>
