<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Vetos de Mapas - Torneio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  margin:0;
  font-family:Arial,sans-serif;
  color:#fff;
  overflow-x:hidden;
}

#yt-bg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  overflow: hidden;
}
#yt-bg iframe {
  width: 177.77vh;
  height: 100vh;
  min-width: 100vw;
  min-height: 56.25vw;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
  filter: brightness(0.5);
}

.tela{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.box{
  background:rgba(20,20,20,0.95);
  padding:25px;
  border-radius:15px;
  width:100%;
  max-width:500px;
  text-align:center;
  box-shadow:0 0 15px rgba(0,0,0,0.7);
  transition: transform 0.3s ease;
}
.box:hover { transform: scale(1.02); }

button{
  padding:10px 20px; margin:5px; border:none; border-radius:8px; cursor:pointer;
  background: linear-gradient(90deg,#4cafef,#1a73e8);
  color:#fff;
  font-weight:bold;
  transition:0.2s;
}
button:hover{ opacity:0.9; }
button:disabled{ opacity:0.5; cursor:not-allowed; }

.map-grid{ display:flex; flex-wrap:wrap; justify-content:center; gap:12px; margin-top:15px; }
.map-item{ width:140px; text-align:center; cursor:pointer; border-radius:10px; overflow:hidden; box-shadow:0 0 10px rgba(0,0,0,0.5); transition: transform 0.3s ease, box-shadow 0.3s ease;}
.map-item img{ width:100%; border-radius:10px; transition: transform 0.3s ease; }
.map-item:hover{ transform: scale(1.08); box-shadow:0 0 20px rgba(0,150,255,0.7); }
.map-item.final img { animation: pulse 1s infinite alternate; }

@keyframes pulse {
  0% { transform: scale(1) }
  100% { transform: scale(1.1) }
}

#mensagemFixa {
  font-size:0.9em;
  color:#ccc;
  margin-bottom:5px;
}
#mensagemTurno {
  font-weight:bold;
  font-size:1.1em;
  margin-bottom:6px;
  color:#ffeb3b;
  text-shadow: 0 0 5px rgba(0,0,0,0.7);
}
#contador {
  font-size:1em;
  color:#00ff99;
  margin-bottom:12px;
}
</style>
</head>
<body>

<div id="yt-bg">
  <iframe 
    src="https://www.youtube.com/embed/bSapqDCxlgw?autoplay=1&mute=1&controls=0&loop=1&playlist=bSapqDCxlgw" 
    frameborder="0"
    allow="autoplay; fullscreen" 
    allowfullscreen>
  </iframe>
</div>

<div id="telaInicial" class="tela" style="display:flex;">
  <div class="box">
    <h1>Vetos de Mapas</h1>
    <button onclick="abrirModo()">Iniciar Vetos</button>
  </div>
</div>

<div id="telaModo" class="tela">
  <div class="box">
    <h1>Escolha o modo</h1>
    <button onclick="gerarSala(1)">MD1</button>
    <button onclick="gerarSala(3)">MD3</button>
    <button onclick="gerarSala(5)">MD5</button>
    <button onclick="voltarTelaInicial()">Voltar</button>
  </div>
</div>

<div id="telaSala" class="tela">
  <div class="box">
    <h2>Link da sala</h2>
    <p id="linkSala"></p>
    <button onclick="copiarLink()">ðŸ“‹ Copiar Link</button>
    <button onclick="iniciarVeto()">Entrar na Sala</button>
  </div>
</div>

<div id="telaVeto" class="tela">
  <div class="box">
    <h1>Vetos de Mapas</h1>
    <div id="mensagemFixa">O jogador que escolher o mapa primeiro escolhe tambÃ©m o lado</div>
    <div id="mensagemTurno">Aguardando adversÃ¡rio...</div>
    <div id="contador">Tempo restante: 15s</div>
    <div class="map-grid" id="mapasContainer"></div>
  </div>
</div>

<div id="telaResultado" class="tela">
  <div class="box">
    <h1>Mapas Escolhidos</h1>
    <div class="map-grid" id="mapasFinais"></div>
    <button onclick="window.location.reload()">Encerrar SessÃ£o</button>
  </div>
</div>

<script>
const mapas = [
  {nome:'5TH DEPOT', img:'dp5.mapa.png'},
  {nome:'CROSSPORT', img:'crossport.png'},
  {nome:'DESERT2', img:'desert2.png'},
  {nome:'PROVENCE', img:'provence.png'},
  {nome:'CITY CAT', img:'citycat.png'},
  {nome:'WHITE SQUALL', img:'wihtiSqual.png'},
  {nome:'OLD TOWM', img:'oldTowm.png'},
  {nome:'DRAGONROAD', img:'dragonround.png'},
  {nome:'TWOFACE', img:'TOWFACE.jpg'},
  {nome:'DEPOT', img:'DEPOT.png'}
];

const firebaseConfig = {
  apiKey: "AIzaSyCk5TKmEJbeoyO4GunMmsAzHQksaY7FeNU",
  authDomain: "vetos-de-mapas.firebaseapp.com",
  databaseURL: "https://vetos-de-mapas-default-rtdb.firebaseio.com",
  projectId: "vetos-de-mapas",
  storageBucket: "vetos-de-mapas.appspot.com",
  messagingSenderId: "965916020174",
  appId: "1:965916020174:web:676ae987f76b10631e6f9f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let modo = 1;
let salaID = "";
let jogadorID = Math.random().toString(36).substring(2,8);
let mapasVetados = [];
let jogador1 = "";
let jogador2 = "";
let isMeuTurno = false;
let turnoTipo = "escolher";
let contador = 15;
let timerInterval;

const params = new URLSearchParams(window.location.search);
const salaParam = params.get("sala");
const jogadorParam = params.get("jogador");

if(salaParam && jogadorParam){
    salaID = salaParam;
    jogadorID = jogadorParam;
    document.getElementById("telaInicial").style.display = "none";
    document.getElementById("telaModo").style.display = "none";
    document.getElementById("telaSala").style.display = "none";
    document.getElementById("telaVeto").style.display = "flex";
    inicializarFirebase();
    renderizarMapas();
}

function abrirModo(){ document.getElementById("telaInicial").style.display="none"; document.getElementById("telaModo").style.display="flex";}
function voltarTelaInicial(){ document.getElementById("telaModo").style.display="none"; document.getElementById("telaInicial").style.display="flex";}
function copiarLink(){ navigator.clipboard.writeText(document.getElementById("linkSala").innerText); alert("Link copiado!"); }

function gerarSala(sel){
  modo = sel;
  salaID = Math.random().toString(36).substring(2,8);
  db.ref("salas/" + salaID).set({
    modo: modo,
    jogador1: jogadorID,
    vetos: {},
    turno: jogadorID,
    turnoTipo: "escolher"
  });
  const link = `${location.origin}${location.pathname}?sala=${salaID}&jogador=${Math.random().toString(36).substring(2,8)}`;
  document.getElementById("linkSala").innerHTML = `<a href="${link}" target="_blank">${link}</a>`;
  document.getElementById("telaModo").style.display="none";
  document.getElementById("telaSala").style.display="flex";
}

function iniciarVeto(){ 
  document.getElementById("telaSala").style.display="none"; 
  document.getElementById("telaVeto").style.display="flex"; 
  inicializarFirebase(); 
  renderizarMapas(); 
}

function renderizarMapas(){
  const c = document.getElementById("mapasContainer");
  c.innerHTML = "";
  mapas.forEach(m => {
    const div = document.createElement("div");
    div.className = "map-item";
    div.innerHTML = `<img src="${m.img}"><p>${m.nome}</p>`;
    if(mapasVetados.includes(m.nome) || !isMeuTurno){ div.querySelector("img").style.opacity = "0.5"; div.style.pointerEvents = "none"; }
    div.onclick = () => { jogarMapa(m.nome); };
    c.appendChild(div);
  });
}

function jogarMapa(nome){
  if(!isMeuTurno) return;
  db.ref("salas/" + salaID + "/vetos").push({ mapa: nome, jogador: jogadorID, tipo: turnoTipo }).then(()=>{
    const proximoTurno = (jogadorID === jogador1) ? jogador2 : jogador1;
    const proximoTipo = (turnoTipo === "escolher") ? "vetar" : "escolher";
    db.ref("salas/" + salaID).update({ turno: proximoTurno, turnoTipo: proximoTipo });
  });
}

function iniciarContador(){
  clearInterval(timerInterval);
  contador = 15;
  document.getElementById("contador").innerText = `Tempo restante: ${contador}s`;
  timerInterval = setInterval(()=>{
    if(!isMeuTurno){ clearInterval(timerInterval); return; }
    contador--;
    document.getElementById("contador").innerText = `Tempo restante: ${contador}s`;
    if(contador <= 0){
      clearInterval(timerInterval);
      const proximoTurno = (jogadorID === jogador1) ? jogador2 : jogador1;
      const proximoTipo = (turnoTipo === "escolher") ? "vetar" : "escolher";
      db.ref("salas/" + salaID).update({ turno: proximoTurno, turnoTipo: proximoTipo });
    }
  },1000);
}

function inicializarFirebase(){
  db.ref("salas/" + salaID).on("value", snap => {
    const sala = snap.val();
    if(!sala) return;
    jogador1 = sala.jogador1;
    jogador2 = sala.jogador2 || "";
    if(!jogador2 && jogadorID !== jogador1){ db.ref("salas/" + salaID).update({ jogador2: jogadorID }); jogador2 = jogadorID; }
    const vetosObj = sala.vetos || {};
    mapasVetados = Object.values(vetosObj).map(v=>v.mapa);
    turnoTipo = sala.turnoTipo || "escolher";
    isMeuTurno = (sala.turno === jogadorID);

    const msg = isMeuTurno ? (turnoTipo==="escolher"?"Sua vez de escolher":"Sua vez de vetar"):"Aguardando adversÃ¡rio...";
    document.getElementById("mensagemTurno").innerText = msg;

    renderizarMapas();
    if(isMeuTurno){ iniciarContador(); } else { clearInterval(timerInterval); }

    const finais = mapas.filter(m => !mapasVetados.includes(m.nome));
    if(finais.length <= modo){
      document.getElementById("telaVeto").style.display="none";
      const c = document.getElementById("mapasFinais");
      c.innerHTML = "";
      finais.forEach(m=>{
        const div = document.createElement("div");
        div.className="map-item final";
        div.innerHTML=`<img src="${m.img}"><p>${m.nome}</p>`;
        c.appendChild(div);
      });
      document.getElementById("telaResultado").style.display="flex";
    }
  });
}
</script>
</body>
</html>
