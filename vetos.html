<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Vetos de Mapas - SABR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
    body {
        margin:0;
        font-family:Arial;
        color:white;
        overflow:hidden;
        background:#000;
    }

    /* FUNDO YOUTUBE */
    #yt-bg{
        position: fixed;
        inset:0;
        z-index:-3;
        overflow:hidden;
    }
    #yt-bg iframe{
        width:177.7vh;
        height:100vh;
        min-width:100vw;
        min-height:56.25vw;
        position:absolute;
        top:50%; left:50%;
        transform:translate(-50%, -50%);
        pointer-events:none;
    }

    /* MENSAGEM VETO NEON */
    #msgVeto {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(255,0,0,0.9);
        color: yellow;
        font-size: 22px;
        font-weight: bold;
        padding: 15px 20px;
        border-radius: 12px;
        z-index: 999;
        text-align: center;
        box-shadow: 0 0 20px #ff0;
        animation: piscarTremor 0.8s infinite;
        pointer-events: none;
    }

    @keyframes piscarTremor {
        0% {opacity:1; transform: translate(0,0);}
        25% {opacity:0.5; transform: translate(-3px,-2px) rotate(-1deg);}
        50% {opacity:1; transform: translate(3px,2px) rotate(1deg);}
        75% {opacity:0.5; transform: translate(-2px,2px) rotate(-1deg);}
        100% {opacity:1; transform: translate(0,0);}
    }

    /* TELAS */
    .tela{
        position:fixed;
        inset:0;
        display:none;
        justify-content:center;
        align-items:center;
        background:rgba(0,0,0,0.70);
        backdrop-filter: blur(3px);
        z-index:10;
    }
    .box{
        background:rgba(20,20,20,0.92);
        padding:30px;
        border-radius:18px;
        border:1px solid #ff2a2a;
        width:100%;
        max-width:500px;
        text-align:center;
        box-shadow:0 0 15px #ff1e1e55;
    }

    /* BOT√ïES NEON */
    button{
        padding:12px 25px;
        margin:7px;
        border:none;
        border-radius:10px;
        cursor:pointer;
        font-size:18px;
        color:white;
        background:#ff0000;
        box-shadow:0 0 10px #ff0000aa;
        animation:pulse 1.3s infinite;
        transition:0.2s;
    }
    button:hover{
        box-shadow:0 0 18px #ff0000ff;
        transform:scale(1.05);
    }
    @keyframes pulse{
        0%{box-shadow:0 0 10px #ff0000;}
        50%{box-shadow:0 0 25px #ff2020;}
        100%{box-shadow:0 0 10px #ff0000;}
    }
    button:disabled{
        opacity:0.4;
        box-shadow:none;
        animation:none;
        cursor:not-allowed;
    }

    /* MAPAS NEON */
    .map-grid{
        display:flex;
        flex-wrap:wrap;
        justify-content:center;
        gap:14px;
        margin-top:15px;
    }
    .map-item{
        width:150px;
        cursor:pointer;
        text-align:center;
    }
    .map-item img{
        width:100%;
        border-radius:10px;
        transition:.25s;
        border:2px solid #009dff33;
        box-shadow:0 0 10px #009dff55;
    }
    .map-item img:hover{
        transform:scale(1.05);
        box-shadow:0 0 15px #00c8ff;
    }

    .escolhido{
        border:2px solid #00eaff !important;
        box-shadow:0 0 18px #00eaff;
    }
    .bloqueado img{
        filter:brightness(0.15);
        box-shadow:none;
        transform:none;
        pointer-events:none;
    }

    .turno-msg{
        font-size:18px;
        color:#0ff;
        margin-top:10px;
        text-shadow:0 0 8px #00eaff;
    }
</style>
</head>

<body>

<!-- FUNDO YOUTUBE -->
<div id="yt-bg">
    <iframe src="https://www.youtube.com/embed/bSapqDCxlgw?autoplay=1&mute=1&controls=0&loop=1&playlist=bSapqDCxlgw"></iframe>
</div>

<!-- MENSAGEM VETO -->
<div id="msgVeto" style="display:none;">
‚ö† Quem escolheu o mapa primeiro, o advers√°rio escolhe o lado!
</div>

<!-- TELAS -->
<div id="telaInicial" class="tela" style="display:flex;">
    <div class="box">
        <h1>Vetos de Mapas</h1>
        <button onclick="abrirModo()">Iniciar Vetos</button>
    </div>
</div>

<div id="telaModo" class="tela">
    <div class="box">
        <h1>Escolha o modo</h1>
        <button onclick="gerarSala(1)">MD1</button>
        <button onclick="gerarSala(3)">MD3</button>
        <button onclick="gerarSala(5)">MD5</button>
        <button onclick="voltarTelaInicial()">Voltar</button>
    </div>
</div>

<div id="telaSala" class="tela">
    <div class="box">
        <h2>Sua Sala</h2>
        <p>Envie o link ao Jogador 2:</p>
        <p id="linkSala"></p>
        <button onclick="copiarLink()">üìã Copiar Link</button>
        <button onclick="entrarSala()">Entrar</button>
    </div>
</div>

<div id="telaVeto" class="tela">
    <div class="box">
        <h1>Escolha de Mapas</h1>
        <div class="turno-msg" id="infoTurno">Aguardando...</div>
        <div id="esperaTurno" style="display:none; margin:10px; color:#0ff;">
            Aguardando o Jogador advers√°rio...
        </div>
        <button id="btnSuaVez" style="display:none; margin-bottom:10px;" onclick="liberarTurno()">
            CONTINUAR
        </button>
        <div class="map-grid" id="mapasContainer"></div>
        <button id="encerrarBtn" style="display:none;" onclick="encerrarSessao()">Encerrar Sess√£o</button>
    </div>
</div>

<div id="telaResultado" class="tela">
    <div class="box">
        <h1>Mapas Escolhidos</h1>
        <div class="map-grid" id="mapasFinais"></div>
        <button onclick="location.reload()">Voltar ao In√≠cio</button>
    </div>
</div>

<script>
/* MAPAS */
const mapas = [
    {nome:'5TH DEPOT', img:'dp5.mapa.png'},
    {nome:'CROSSPORT', img:'crossport.png'},
    {nome:'DESERT2', img:'desert2.png'},
    {nome:'PROVENCE', img:'provence.png'},
    {nome:'CITY CAT', img:'citycat.png'},
    {nome:'WHITE SQUALL', img:'wihtiSqual.png'},
    {nome:'OLD TOWM', img:'oldTowm.png'},
    {nome:'DRAGONROAD', img:'dragonround.png'},
    {nome:'TWOFACE', img:'TOWFACE.jpg'},
    {nome:'DEPOT', img:'DEPOT.png'}
];

/* FIREBASE */
firebase.initializeApp({
    apiKey:"AIzaSyCk5TKmEJbeoyO4GunMmsAzHQksaY7FeNU",
    authDomain:"vetos-de-mapas.firebaseapp.com",
    databaseURL:"https://vetos-de-mapas-default-rtdb.firebaseio.com",
    projectId:"vetos-de-mapas"
});

const db = firebase.database();

/* VARI√ÅVEIS */
let modo = 1;
let salaID = "";
let jogadorID = Math.random().toString(36).substring(2,8);
let vez = "";
let escolhas = [];
let salaDados={};

/* PARAMS SALA */
const params = new URLSearchParams(location.search);
if(params.get("sala")){
    salaID = params.get("sala");
    jogadorID = params.get("jogador");
    entrarDirect();
}

/* TELAS */
function abrirModo(){ show("telaModo"); hide("telaInicial"); }
function voltarTelaInicial(){ show("telaInicial"); hide("telaModo"); }
function show(id){ document.getElementById(id).style.display="flex"; }
function hide(id){ document.getElementById(id).style.display="none"; }

/* GERAR SALA */
function gerarSala(m){
    modo=m;
    salaID = Math.random().toString(36).substring(2,8);
    vez = Math.random()<0.5 ? "j1" : "j2";

    db.ref("salas/"+salaID).set({
        modo, j1:jogadorID, j2:"", vez, escolhas:[], travado:true
    });

    const link = `${location.origin}${location.pathname}?sala=${salaID}&jogador=${Math.random().toString(36).substring(2,8)}`;
    document.getElementById("linkSala").innerHTML = `<a href="${link}" target="_blank">${link}</a>`;

    hide("telaModo");
    show("telaSala");
}

function copiarLink(){
    navigator.clipboard.writeText(document.getElementById("linkSala").innerText);
    alert("Link copiado!");
}

function entrarSala(){
    hide("telaSala");
    show("telaVeto");
    document.getElementById("msgVeto").style.display = "block"; // mostra mensagem chamativa
    inicializar();
}

function entrarDirect(){
    hide("telaInicial");
    hide("telaModo");
    hide("telaSala");
    show("telaVeto");
    document.getElementById("msgVeto").style.display = "block"; // mostra mensagem chamativa
    inicializar();
}

/* RENDER MAPAS */
function renderizar(){
    const c=document.getElementById("mapasContainer");
    c.innerHTML="";
    mapas.forEach(m=>{
        const d=document.createElement("div");
        d.className="map-item";
        if(escolhas.includes(m.nome)) {
            d.classList.add("bloqueado");
        }
        let bloqueado = (vez!==meuTime() || escolhas.includes(m.nome));
        if(bloqueado) d.classList.add("bloqueado");
        d.innerHTML = `<img src="${m.img}"><p>${m.nome}</p>`;
        d.onclick = ()=> selecionar(m.nome);
        c.appendChild(d);
    });
}

/* SELECIONAR */
function selecionar(nome){
    if(vez!==meuTime()) return;
    if(escolhas.includes(nome)) return;
    if(escolhas.length>=modo) return;

    escolhas.push(nome);
    db.ref("salas/"+salaID+"/escolhas").set(escolhas);
    db.ref("salas/"+salaID+"/travado").set(true);
    db.ref("salas/"+salaID+"/vez").set(oponente());
}

/* CONTINUAR */
function liberarTurno(){
    db.ref("salas/"+salaID+"/travado").set(false);
    document.getElementById("btnSuaVez").style.display="none";
}

/* TIME */
function meuTime(){ return jogadorID === salaDados.j1 ? "j1" : "j2"; }
function oponente(){ return meuTime()==="j1" ? "j2" : "j1"; }

/* FIREBASE SYNC */
function inicializar(){
    db.ref("salas/"+salaID).on("value", snap=>{
        salaDados = snap.val();
        if(!salaDados) return location.reload();

        modo = salaDados.modo;
        escolhas = salaDados.escolhas || [];
        vez = salaDados.vez;

        atualizarTurno();
        renderizar();

        if(escolhas.length===modo) mostrarResultado();
    });
}

/* TURNO */
function atualizarTurno(){
    const msg = document.getElementById("infoTurno");
    const espera = document.getElementById("esperaTurno");
    const btn = document.getElementById("btnSuaVez");

    if(salaDados.travado){
        if(vez===meuTime()){
            msg.innerHTML="Aguardando o advers√°rio...";
            espera.style.display="block";
            btn.style.display="none";
        } else {
            msg.innerHTML="Clique em CONTINUAR";
            btn.style.display="block";
            espera.style.display="none";
        }
    } else {
        if(vez===meuTime()){
            msg.innerHTML="Seu turno!";
            espera.style.display="none";
            btn.style.display="none";
        } else {
            msg.innerHTML="Turno do advers√°rio...";
            espera.style.display="block";
            btn.style.display="none";
        }
    }
}

/* RESULTADO */
function mostrarResultado(){
    hide("telaVeto");
    show("telaResultado");
    document.getElementById("msgVeto").style.display = "none"; // esconde mensagem

    const c=document.getElementById("mapasFinais");
    c.innerHTML="";
    escolhas.forEach(n=>{
        const m = mapas.find(x=>x.nome===n);
        c.innerHTML += `<div class="map-item"><img src="${m.img}"><p>${m.nome}</p></div>`;
    });
}

function encerrarSessao(){
    db.ref("salas/"+salaID).remove();
    location.reload();
}
</script>

</body>
</html>
