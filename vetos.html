<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Vetos de Mapas - SABR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body { margin:0; font-family:Arial; color:white; }

/* FUNDO YT */
#yt-bg {
  position: fixed; inset:0; z-index:-1; overflow:hidden;
}
#yt-bg iframe {
  width:177.7vh; height:100vh; min-width:100vw; min-height:56.25vw;
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  pointer-events:none;
}

/* TELAS */
.tela {
  position:fixed; inset:0;
  display:none; justify-content:center; align-items:center;
  background:rgba(0,0,0,0.85); z-index:10;
}
.box{
  background:#111; padding:25px; border-radius:15px;
  width:100%; max-width:500px; text-align:center;
}

/* MAPAS */
.map-grid{
  display:flex; flex-wrap:wrap; justify-content:center; gap:12px; margin-top:15px;
}
.map-item{ width:140px; cursor:pointer; text-align:center; }
.map-item img{ width:100%; border-radius:10px; transition:.3s; }
.map-item img:hover{ transform:scale(1.05); }

.escolhido{
  box-shadow:0 0 12px #00eaff;
  outline:2px solid #00eaff;
}

/* BLOQUEADO */
.bloqueado img{
  filter:brightness(0.2);
  pointer-events:none;
}

.turno-msg{ font-size:17px; color:#0ff; margin-top:10px; }

button{
  padding:10px 20px; margin:5px; border:none;
  border-radius:8px; cursor:pointer; font-size:16px;
}
button:disabled{ opacity:0.5; cursor:not-allowed; }
</style>
</head>
<body>

<!-- FunDO -->
<div id="yt-bg">
  <iframe src="https://www.youtube.com/embed/bSapqDCxlgw?autoplay=1&mute=1&controls=0&loop=1&playlist=bSapqDCxlgw"></iframe>
</div>

<!-- TELAS -->
<div id="telaInicial" class="tela" style="display:flex;">
  <div class="box">
    <h1>Vetos de Mapas</h1>
    <button onclick="abrirModo()">Iniciar Vetos</button>
  </div>
</div>

<div id="telaModo" class="tela">
  <div class="box">
    <h1>Escolha o modo</h1>
    <button onclick="gerarSala(1)">MD1</button>
    <button onclick="gerarSala(3)">MD3</button>
    <button onclick="gerarSala(5)">MD5</button>
    <button onclick="voltarTelaInicial()">Voltar</button>
  </div>
</div>

<div id="telaSala" class="tela">
  <div class="box">
    <h2>Sua Sala</h2>
    <p>Envie o link ao Jogador 2:</p>
    <p id="linkSala"></p>
    <button onclick="copiarLink()">üìã Copiar Link</button>
    <button onclick="entrarSala()">Entrar</button>
  </div>
</div>

<div id="telaVeto" class="tela">
  <div class="box">
    <h1>Escolha de Mapas</h1>
    <div class="turno-msg" id="infoTurno">Aguardando...</div>

    <div id="esperaTurno" style="display:none; margin:10px; color:#0ff;">
      Aguardando o Jogador advers√°rio...
    </div>

    <button id="btnSuaVez" style="display:none; margin-bottom:10px;" onclick="liberarTurno()">
      SUA VEZ
    </button>

    <div class="map-grid" id="mapasContainer"></div>

    <button id="encerrarBtn" style="display:none;" onclick="encerrarSessao()">
      Encerrar Sess√£o
    </button>
  </div>
</div>

<div id="telaResultado" class="tela">
  <div class="box">
    <h1>Mapas Escolhidos</h1>
    <div class="map-grid" id="mapasFinais"></div>
    <button onclick="location.reload()">Voltar ao In√≠cio</button>
  </div>
</div>

<script>
// MAPAS
const mapas = [
  {nome:'5TH DEPOT', img:'dp5.mapa.png'},
  {nome:'CROSSPORT', img:'crossport.png'},
  {nome:'DESERT2', img:'desert2.png'},
  {nome:'PROVENCE', img:'provence.png'},
  {nome:'CITY CAT', img:'citycat.png'},
  {nome:'WHITE SQUALL', img:'wihtiSqual.png'},
  {nome:'OLD TOWM', img:'oldTowm.png'},
  {nome:'DRAGONROAD', img:'dragonround.png'},
  {nome:'TWOFACE', img:'TOWFACE.jpg'},
  {nome:'DEPOT', img:'DEPOT.png'}
];

// FIREBASE
firebase.initializeApp({
  apiKey:"AIzaSyCk5TKmEJbeoyO4GunMmsAzHQksaY7FeNU",
  authDomain:"vetos-de-mapas.firebaseapp.com",
  databaseURL:"https://vetos-de-mapas-default-rtdb.firebaseio.com",
  projectId:"vetos-de-mapas"
});
const db = firebase.database();

// VARI√ÅVEIS
let modo = 1;
let salaID = "";
let jogadorID = Math.random().toString(36).substring(2,8);
let vez = "";
let escolhas = [];

const params = new URLSearchParams(location.search);
if(params.get("sala")){
  salaID = params.get("sala");
  jogadorID = params.get("jogador");
  entrarDirect();
}

// ***** TELAS *****
function abrirModo(){ show("telaModo"); hide("telaInicial"); }
function voltarTelaInicial(){ show("telaInicial"); hide("telaModo"); }

function show(id){ document.getElementById(id).style.display="flex"; }
function hide(id){ document.getElementById(id).style.display="none"; }

// GERAR SALA
function gerarSala(m){
  modo=m;
  salaID = Math.random().toString(36).substring(2,8);

  vez = Math.random()<0.5 ? "j1" : "j2";

  db.ref("salas/"+salaID).set({
    modo,
    j1:jogadorID,
    j2:"",
    vez,
    escolhas:[],
    travado:true
  });

  const link = `${location.origin}${location.pathname}?sala=${salaID}&jogador=${Math.random().toString(36).substring(2,8)}`;
  document.getElementById("linkSala").innerHTML = `<a href="${link}" target="_blank">${link}</a>`;

  hide("telaModo"); show("telaSala");
}

function copiarLink(){
  navigator.clipboard.writeText(document.getElementById("linkSala").innerText);
  alert("Link copiado!");
}

function entrarSala(){
  hide("telaSala"); show("telaVeto");
  inicializar();
}

function entrarDirect(){
  hide("telaInicial"); hide("telaModo"); hide("telaSala");
  show("telaVeto");
  inicializar();
}

// RENDER MAPAS
function renderizar(){
  const c = document.getElementById("mapasContainer");
  c.innerHTML="";

  mapas.forEach(m=>{
    const d=document.createElement("div");
    d.className="map-item";

    let bloqueado = (vez !== meuTime());
    if(bloqueado) d.classList.add("bloqueado");

    d.innerHTML = `<img src="${m.img}"><p>${m.nome}</p>`;

    if(escolhas.includes(m.nome)){
      d.querySelector("img").classList.add("escolhido");
      d.classList.add("bloqueado");
    }

    d.onclick = () => selecionar(m.nome);
    c.appendChild(d);
  });
}

// SELECIONAR MAPA
function selecionar(nome){
  if(vez!==meuTime()) return;
  if(escolhas.includes(nome)) return;
  if(escolhas.length>=modo) return;

  escolhas.push(nome);
  db.ref("salas/"+salaID+"/escolhas").set(escolhas);

  // bloqueia turno
  db.ref("salas/"+salaID+"/travado").set(true);

  // troca turno
  db.ref("salas/"+salaID+"/vez").set(oponente());
}

// LIBERAR TURNO
function liberarTurno(){
  db.ref("salas/"+salaID+"/travado").set(false);
  document.getElementById("btnSuaVez").style.display="none";
}

// MEU LADO
function meuTime(){
  return jogadorID === salaDados.j1 ? "j1" : "j2";
}
function oponente(){ return meuTime()==="j1" ? "j2" : "j1"; }

// MAIN FIREBASE
let salaDados={};

function inicializar(){
  db.ref("salas/"+salaID).on("value", snap=>{
    salaDados = snap.val();
    if(!salaDados) return location.reload();

    modo = salaDados.modo;
    escolhas = salaDados.escolhas || [];
    vez = salaDados.vez;

    atualizarTurno();
    renderizar();

    if(escolhas.length===modo) mostrarResultado();
  });
}

function atualizarTurno(){
  const msg = document.getElementById("infoTurno");
  const espera = document.getElementById("esperaTurno");
  const btn = document.getElementById("btnSuaVez");

  if(salaDados.travado){
    if(vez===meuTime()){
      msg.innerHTML="Aguardando advers√°rio clicar em SUA VEZ...";
      espera.style.display="block";
      btn.style.display="none";
    } else {
      msg.innerHTML="Mapa escolhido - Clique em SUA VEZ para continuar!";
      btn.style.display="block";
      espera.style.display="none";
    }
  } else {
    if(vez===meuTime()){
      msg.innerHTML="Seu turno!";
      espera.style.display="none";
      btn.style.display="none";
    } else {
      msg.innerHTML="Turno do advers√°rio...";
      espera.style.display="block";
      btn.style.display="none";
    }
  }
}

// RESULTADO
function mostrarResultado(){
  hide("telaVeto"); show("telaResultado");

  const c=document.getElementById("mapasFinais");
  c.innerHTML="";

  escolhas.forEach(n=>{
    const m = mapas.find(x=>x.nome===n);
    c.innerHTML += `
      <div class="map-item">
        <img src="${m.img}">
        <p>${m.nome}</p>
      </div>`;
  });
}

function encerrarSessao(){
  db.ref("salas/"+salaID).remove();
  location.reload();
}
</script>
</body>
</html>
