<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Eventos SABR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box}
body{
  margin:0;font-family:Arial,sans-serif;color:#fff;
  background:#000;
  display:flex;align-items:center;justify-content:center;
  min-height:100vh;
}
.tela{
  position:fixed;inset:0;background:rgba(0,0,0,.9);
  display:none;align-items:center;justify-content:center;
}
.content{text-align:center}
.box{
  background:#111;padding:25px;border-radius:15px;
  width:100%;max-width:400px;text-align:center
}
.btn{
  width:320px;max-width:100%;padding:18px;margin:10px auto;
  border:none;border-radius:12px;font-size:18px;font-weight:bold;
  cursor:pointer;color:#fff
}
.btn-inscricao{background:#22c55e;color:#000}
.btn-mix{background:#3b82f6}
.btn-voltar{background:#ef4444}
input{
  width:100%;padding:12px;border-radius:8px;border:none;margin-bottom:10px
}
.roleta{
  width:180px;height:180px;border-radius:50%;
  border:8px solid #22c55e;margin:15px auto;
  display:flex;align-items:center;justify-content:center;
  font-size:36px;font-weight:bold
}
</style>
</head>

<body>

<!-- TELA INICIAL -->
<div class="content">
  <h1>EVENTOS SABR</h1>
  <button class="btn btn-inscricao" onclick="abrirMix()">üìù INSCREVER-SE</button>
</div>

<!-- MIX -->
<div id="telaMix" class="tela">
  <div class="box">

    <h2>MIX SA</h2>
    <p><strong>Valor: R$ 4,00</strong></p>

    <input id="nome" placeholder="Digite seu nick">

    <p><strong>PIX:</strong></p>
    <img id="qrPix" width="150" style="display:none">
    <p id="msgPix">Clique em <b>J√Å PAGUEI</b> para gerar o PIX</p>

    <button class="btn btn-inscricao" onclick="liberar()">J√Å PAGUEI</button>

    <div class="roleta" id="roleta">?</div>

    <button class="btn btn-mix" id="btnGirar" onclick="girar()" disabled>
      üéØ GIRAR ROLETA
    </button>

    <p id="resultado"></p>
    <p id="status"></p>

    <button class="btn btn-voltar" onclick="fechar()">‚ùå SAIR</button>

  </div>
</div>

<script>
const LIMITE = 5;
let equipes = {1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0};
let jaGirou = false;
let pagamentoId = null;

function abrirMix(){
  document.getElementById("telaMix").style.display="flex";
  atualizarStatus();
}

function fechar(){
  document.getElementById("telaMix").style.display="none";
}

async function liberar(){
  const nick = nome.value.trim();
  if(!nick){
    alert("Digite seu nick!");
    return;
  }

  document.getElementById("msgPix").innerText = "Gerando PIX...";

  const res = await fetch("http://localhost:3000/criar-pagamento", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ nome: nick })
  });

  const data = await res.json();
  pagamentoId = data.id;

  const img = document.getElementById("qrPix");
  img.src = "data:image/png;base64," + data.qr_base64;
  img.style.display = "block";

  document.getElementById("msgPix").innerText =
    "Escaneie o QR Code e pague";

  verificarPagamento();
}

async function verificarPagamento(){
  const timer = setInterval(async () => {
    const res = await fetch(
      `http://localhost:3000/status/${pagamentoId}`
    );
    const data = await res.json();

    if(data.status === "approved"){
      clearInterval(timer);
      document.getElementById("msgPix").innerText =
        "‚úÖ Pagamento confirmado!";
      btnGirar.disabled = false;
    }
  }, 3000);
}

function equipesDisponiveis(){
  return Object.keys(equipes).filter(e => equipes[e] < LIMITE);
}

function girar(){
  if(jaGirou) return;

  const disponiveis = equipesDisponiveis();
  if(disponiveis.length === 0){
    document.getElementById("resultado").innerHTML =
      "üö´ <b>MIX LOTADO</b><br>Inscri√ß√µes encerradas.";
    btnGirar.disabled=true;
    return;
  }

  jaGirou = true;
  btnGirar.disabled=true;

  let tempo = 0;
  let intervalo = setInterval(()=>{
    const e = disponiveis[Math.floor(Math.random()*disponiveis.length)];
    roleta.innerText = e;
    tempo += 100;

    if(tempo >= 2000){
      clearInterval(intervalo);
      equipes[e]++;
      document.getElementById("resultado").innerHTML =
        "‚úÖ Voc√™ ficou na <b>SALA " + e + "</b>";
      atualizarStatus();
    }
  },100);
}

function atualizarStatus(){
  const total = Object.values(equipes).reduce((a,b)=>a+b,0);
  document.getElementById("status").innerHTML =
    `Vagas preenchidas: <b>${total}/40</b>`;
}
</script>

</body>
</html>
